name: PR Automation

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  pr:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_REPO: ${{ github.repository }}
    steps:
      - name: Checkout CI commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Create local branch
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          echo "Target Branch: $BRANCH"
          
          # ブランチ名がない場合は終了
          if [ -z "$BRANCH" ]; then
            echo "No branch name found. Exiting."
            exit 0
          fi

          # 対象ブランチ（feature/ または fix/）以外は終了
          case "$BRANCH" in
            feature/*|fix/*) ;;
            *) echo "Branch $BRANCH is not eligible. Exiting."; exit 0 ;;
          esac

          # Detached HEAD状態から、ブランチ名付きのローカルブランチへ切り替え
          git checkout -b "$BRANCH"

          # 後のステップで参照するために環境変数へセット
          echo "TARGET_BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: Create PR if not exists
        id: create_pr
        run: |
          # 既存のPRを確認
          PR_NUMBER=$(gh pr list --head "$TARGET_BRANCH" --base main --json number -q '.[0].number')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "PR already exists: #$PR_NUMBER"
          else
            echo "Creating new PR..."
            # コミットメッセージからタイトルと本文を取得
            PR_TITLE=$(git log -1 --pretty=%s)
            PR_BODY=$(git log -1 --pretty=%b)
            
            # タイトルが空の場合のフォールバック
            if [ -z "$PR_TITLE" ]; then
              PR_TITLE="Auto-created PR for $TARGET_BRANCH"
            fi

            # PRを作成 (明示的にtitleとbodyを指定することで --fill エラーを回避)
            gh pr create \
              --head "$TARGET_BRANCH" \
              --base main \
              --title "$PR_TITLE" \
              --body "$PR_BODY"
            
            # 作成したPR番号を再取得
            PR_NUMBER=$(gh pr list --head "$TARGET_BRANCH" --base main --json number -q '.[0].number')
          fi

          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Enable auto-merge
        if: ${{ steps.create_pr.outputs.pr_number != '' }}
        run: |
          echo "Enabling auto-merge for PR #${{ steps.create_pr.outputs.pr_number }}"
          gh pr merge "${{ steps.create_pr.outputs.pr_number }}" --auto --squash --delete-branch
